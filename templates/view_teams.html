{% extends 'base.html' %}

{% block content %}
<h2>View Teams</h2>

<!-- Flash Messages Section -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="alert-container">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
<!-- End of Flash Messages Section -->

<table class="table">
   <thead>
       <tr>
           <th>Team Name</th>
           <th>Description</th>
           <th>Assigned Contracts</th>
           <th>Team Members</th>
           <th>Actions</th>
       </tr>
   </thead>
   <tbody>
       {% for team in teams %}
       <tr>
           <td style="color: #333; background-color: #f9f9f9;">{{ team.name }}</td>
           <td style="color: #333; background-color: #f9f9f9;">{{ team.description }}</td>
           <td style="color: #333; background-color: #f9f9f9;">
               {% if team_contracts[team.id] %}
                   <ul>
                   {% for contract in team_contracts[team.id] %}
                       <li>{{ contract.contract_name }}</li>
                   {% endfor %}
                   </ul>
               {% else %}
                   <span class="text-muted">No contracts assigned</span>
               {% endif %}
           </td>
           <td style="color: #333; background-color: #f9f9f9;">
               {% if team_members[team.id] %}
                   <ul>
                   {% for member in team_members[team.id] %}
                       <li>
                           {{ member.email }} - {{ member.team_memberships[0].role }}
                            <form action="{{ url_for('team.delete_member', team_id=team.id, user_id=member.id) }}" method="POST" style="display: inline;">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">  <!-- Properly include the CSRF token -->
                                <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                            </form>

                       </li>
                   {% endfor %}
                   </ul>
               {% else %}
                   <span class="text-muted">No members</span>
               {% endif %}
           </td>
           <td style="color: #333; background-color: #f9f9f9;">
               <a href="{{ url_for('team.edit_team', team_id=team.id) }}" class="btn btn-warning">Edit</a>
                <form action="{{ url_for('team.delete_team', team_id=team.id) }}" method="POST" style="display: inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">  <!-- Correct usage -->
                    <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                </form>

               <a href="{{ url_for('team.add_member', team_id=team.id) }}" class="btn btn-secondary">Add Member</a>
               <a href="{{ url_for('team.assign_contract', team_id=team.id) }}" class="btn btn-primary">Assign Contract</a>
            </td>
       </tr>
       {% endfor %}
   </tbody>
</table>
{% endblock %}
