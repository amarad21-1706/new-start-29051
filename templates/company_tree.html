{% extends "base.html" %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Tree</title>
    <!-- Include jstree CSS for the tree structure -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

    <style>
        /* Set Home and Back buttons text color */
        .navbar .nav-link, .btn {
            color: #00E0E0 !important;  /* Light salmon for Home and Back */
            background-color: transparent !important;  /* Transparent background */
        }

        .navbar .nav-link:hover, .btn:hover {
            color: #339090 !important;  /* Light blue on hover */
        }

        /* Ensure the tree text is clearly visible */
        company-tree {
            color: #212529;  /* Dark color for the tree text */
        }

        .jstree-anchor {
            color: #00ffff !important;  /* Blue color for the links */
        }


        .jstree-anchor:hover {
            color: #00a1f1 !important;  /* Darker blue on hover for better contrast */
        }

        h1 {
            font-size: 1.5rem;  /* Adjust title font size */
            color: #00ffff;  /* Blue color for the title */
        }

        /* Darker background for buttons in the details box */
        .btn-primary {
            background-color: #0056b3 !important;  /* Darker blue for Edit button */
            border-color: #004494 !important;  /* Matching border color */
        }

        .btn-warning {
            background-color: #008899 !important;  /* Darker orange for Manage Workflow button */
            border-color: #004494 !important;  /* Matching border color */
        }

        .btn-primary:hover, .btn-warning:hover {
            background-color: #003d80 !important;  /* Even darker on hover for Edit button */
            border-color: #003060 !important;  /* Even darker border on hover */
        }

        /* Initially hide the details box */
        #details-box {
            display: none;
        }
    </style>

</head>
<body>
    <div class="container">
        <h1>Company Tree</h1>

        <!-- Company Tree container -->
        <div id="company-tree" class="mt-4"></div>

        <!-- Details Box -->
        <div id="details-box" class="alert alert-info">
            <h3>Details</h3>
            <div id="details-content" class="row">
                <div class="col-md-6">
                    <p><strong>Company ID:</strong> <span id="company-id"></span></p>
                    <p><strong>Company Name:</strong> <span id="company-name"></span></p>
                    <p><strong>User Name:</strong> <span id="user-name"></span></p>
                    <p><strong>Title:</strong> <span id="user-title"></span></p>
                    <p><strong>First Name:</strong> <span id="first-name"></span></p>
                    <p><strong>Last Name:</strong> <span id="last-name"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Role Name:</strong> <span id="role-name"></span></p>
                    <p><strong>Mobile Phone:</strong> <span id="mobile-phone"></span></p>
                    <p><strong>Email:</strong> <span id="email"></span></p>
                </div>
            </div>
            <!-- Edit Button -->
            <div id="edit-buttons" class="mt-3"></div> <!-- Edit button will be dynamically added here -->
        </div>
    </div>

    <!-- Load jQuery and jsTree before your custom script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script>
        $(document).ready(function() {
            // Fetch the company data from the server
            $.getJSON("/api/get_company_data", function(data) {
                const treeData = [];

                // Group data by company
                const companies = {};
                data.forEach(item => {
                    if (!companies[item.company_name]) {
                        companies[item.company_name] = { text: item.company_name, children: [] };
                    }

                    // Add user and role details to the company's children
                    companies[item.company_name].children.push({
                        text: `User: ${item.user_name} - Role: ${item.role_name}`,
                        data: {
                            company_id: item.company_id,
                            company_name: item.company_name,
                            user_name: item.user_name,
                            user_id: item.user_id,  // Add user ID for the Edit button
                            role_name: item.role_name,
                            title: item.title,
                            first_name: item.first_name,
                            last_name: item.last_name,
                            mobile_phone: item.mobile,
                            email: item.email,
                        }
                    });
                });

                // Convert companies object into tree data array
                Object.values(companies).forEach(company => {
                    treeData.push(company);
                });

                // Initialize jsTree with the prepared treeData
                $('#company-tree').jstree({
                    'core': {
                        'data': treeData
                    }
                });

                // Handle tree node click to show details in a box
                $('#company-tree').on("select_node.jstree", function (e, data) {
                    const selectedData = data.node.data;

                    // Populate details box
                    $('#company-id').text(selectedData.company_id);
                    $('#company-name').text(selectedData.company_name);
                    $('#user-name').text(selectedData.user_name || 'N/A');
                    $('#role-name').text(selectedData.role_name || 'N/A');
                    $('#user-title').text(selectedData.title || 'N/A');
                    $('#first-name').text(selectedData.first_name || 'N/A');
                    $('#last-name').text(selectedData.last_name || 'N/A');
                    $('#mobile-phone').text(selectedData.mobile_phone || 'N/A');
                    $('#email').text(selectedData.email || 'N/A');

                    // Create the Edit button dynamically
                    const editButton = `<a href="/open_admin_4/users_data_view/edit/?id=${selectedData.user_id}&url=%2Fopen_admin_4%2Fusers_data_view%2F" class="btn btn-primary">Edit</a>`;
                    $('#edit-buttons').html(editButton);  // Add the Edit button to the #edit-buttons div

                    // Show the details box
                    $('#details-box').show();
                });
            }).fail(function(jqxhr, textStatus, error) {
                const err = textStatus + ", " + error;
                console.error("Request Failed: " + err);
                alert("Error fetching company data: " + err);
            });
        });
    </script>
</body>
</html>
{% endblock %}
