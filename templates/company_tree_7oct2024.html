<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Tree</title>
    <!-- Include jstree CSS for the tree structure -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <style>
        /* Style for the details box */
        #details-box {
            display: none;  /* Initially hide the box */
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Company Tree</h1>

        <!-- Company Tree container -->
        <div id="company-tree"></div>

        <!-- Details Box -->
        <div id="details-box" class="alert alert-info">
            <h3>Details</h3>
            <div id="details-content" class="row">
                <div class="col-md-6">
                    <p><strong>Company ID:</strong> <span id="company-id"></span></p>
                    <p><strong>Company Name:</strong> <span id="company-name"></span></p>
                    <p><strong>User Name:</strong> <span id="user-name"></span></p>
                    <p><strong>Title:</strong> <span id="user-title"></span></p>
                    <p><strong>First Name:</strong> <span id="first-name"></span></p>
                    <p><strong>Last Name:</strong> <span id="last-name"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Role Name:</strong> <span id="role-name"></span></p>
                    <p><strong>Mobile Phone:</strong> <span id="mobile-phone"></span></p>
                    <p><strong>Email:</strong> <span id="email"></span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Load jQuery and jsTree before your custom script -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
    <script>
        $(document).ready(function() {
            // Fetch the company data from the server
            $.getJSON("/api/get_company_data", function(data) {
                const treeData = [];

                // Group data by company
                const companies = {};
                data.forEach(item => {
                    if (!companies[item.company_name]) {
                        companies[item.company_name] = { text: item.company_name, children: [] };
                    }

                    // Add user and role details to the company's children
                    companies[item.company_name].children.push({
                        text: `User: ${item.user_name} - Role: ${item.role_name}`,
                        data: {
                            company_id: item.company_id,
                            company_name: item.company_name,
                            user_name: item.user_name,
                            role_name: item.role_name,
                            title: item.title,
                            first_name: item.first_name,
                            last_name: item.last_name,
                            mobile_phone: item.mobile,
                            email: item.email,
                        }
                    });
                });

                // Convert companies object into tree data array
                Object.values(companies).forEach(company => {
                    treeData.push(company);
                });

                // Initialize jsTree with the prepared treeData
                $('#company-tree').jstree({
                    'core': {
                        'data': treeData
                    }
                });

                // Handle tree node click to show details in a box
                $('#company-tree').on("select_node.jstree", function (e, data) {
                    const selectedData = data.node.data;

                    // Populate details box
                    $('#company-id').text(selectedData.company_id);
                    $('#company-name').text(selectedData.company_name);
                    $('#user-name').text(selectedData.user_name || 'N/A');
                    $('#role-name').text(selectedData.role_name || 'N/A');
                    $('#user-title').text(selectedData.title || 'N/A');
                    $('#first-name').text(selectedData.first_name || 'N/A');
                    $('#last-name').text(selectedData.last_name || 'N/A');
                    $('#mobile-phone').text(selectedData.mobile_phone || 'N/A');
                    $('#email').text(selectedData.email || 'N/A');

                    // Show the details box
                    $('#details-box').show();
                });
            }).fail(function(jqxhr, textStatus, error) {
                const err = textStatus + ", " + error;
                console.error("Request Failed: " + err);
                alert("Error fetching company data: " + err);
            });
        });
    </script>
</body>
</html>
