{% extends 'base.html' %}

{% block content %}
    {% block title %}Products associated to Plans{% endblock %}
    <form method="POST" class="my-8 mx-auto" style="max-width: 80%;">
        {{ form.hidden_tag() }}

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="plan" class="form-label">Select Plan:</label>
                {{ form.plan_id(class="form-control", id="plan-select") }}
            </div>
            <div class="col-md-6">
                <label for="product" class="form-label">Select Product:</label>
                {{ form.product_id(class="form-control") }}
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <label for="associated-products" class="form-label">Associated Products:</label>
                <ul id="associated-products" class="list-group">
                    <!-- Dynamically loaded products will appear here -->
                </ul>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    {{ form.add(class="btn btn-primary me-md-2") }}
                    {{ form.delete(class="btn btn-danger me-md-2") }}
                    {{ form.cancel(class="btn btn-secondary") }}
                </div>
            </div>
        </div>

        {% if message %}
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="alert alert-info" role="alert">
                    {{ message }}
                </div>
            </div>
        </div>
        {% endif %}

    </form>

    <!-- Include Bootstrap JS and Popper.js from CDN (optional) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        $(document).ready(function () {
            // Function to fetch associated products when the plan is changed
            $('#plan-select').change(function () {
                const planId = $(this).val();
                const associatedProductsList = $('#associated-products');

                // Clear previous list of products
                associatedProductsList.empty();

                if (planId) {
                    // Make an AJAX call to fetch products for the selected plan
                    $.getJSON(`/argon/get_plan_products/${planId}`, function (data) {
                        if (data.products.length > 0) {
                            // Populate the associated products list
                            data.products.forEach(function (product) {
                                const listItem = `<li class="list-group-item">${product.name}</li>`;
                                associatedProductsList.append(listItem);
                            });
                        } else {
                            associatedProductsList.append('<li class="list-group-item">No products associated with this plan</li>');
                        }
                    }).fail(function () {
                        associatedProductsList.append('<li class="list-group-item text-danger">Error loading products</li>');
                    });
                } else {
                    associatedProductsList.append('<li class="list-group-item">Please select a plan</li>');
                }
            });
        });

        document.querySelectorAll('select').forEach(selectElement => {
            selectElement.addEventListener('change', function() {
                const messageBox = document.querySelector('.alert-info');
                if (messageBox) {
                    messageBox.style.display = 'none';  // Hide the message box when the selection changes
                }
            });
        });
    </script>

{% endblock %}
