{% extends 'base.html' %}

{% block title %}
    Subscription Plans
{% endblock %}

{% block content %}
<div class="container">
    <h3>Choose Your Subscription Plan</h3>

    <hr>
    <div class="current-subscription" style="color: #aaf0d1;"> <!-- Light green color for current subscription -->
        <h4>Current Subscription</h4>
        <p><strong>Plan:</strong> {{ subscription_info.plan }}</p>
        <p><strong>Status:</strong> {{ subscription_info.status }}</p>
        <p><strong>Start Date:</strong> {{ subscription_info.start_date }}</p>
        <p><strong>End Date:</strong> {{ subscription_info.end_date }}</p>

        <!-- Conditionally display Unsubscribe button if there's an active subscription -->
        {% if subscription_info.status == 'active' %}
            <form action="{{ url_for('cancel_subscription') }}" method="POST" style="margin-top: 10px;">
                {{ form.hidden_tag() }} <!-- CSRF token -->
                <input type="hidden" name="subscription_id" value="{{ subscription_info.id }}"> <!-- Subscription ID -->
                <button type="submit" class="btn btn-danger">Unsubscribe</button>
            </form>
        {% endif %}
    </div>
    <hr>

    <div class="subscription-plans">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="alert-container">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <hr>

        <!-- Conditionally display Subscribe button if there's no active subscription -->
        {% if subscription_info.status != 'active' %}
            <form action="{{ url_for('subscribe') }}" method="POST" id="subscriptionForm">
                {{ form.hidden_tag() }}
                <input type="hidden" name="plan_id" id="plan_id">
                {% for plan in plans %}
                    <div class="plan">
                        <h4 style="background-color: #0b1e39; color: #ffffff; padding: 10px; border-radius: 5px;"> <!-- Dark blue background with white text -->
                            {{ plan.name }}
                        </h4>
                        <p>${{ plan.price / 100 }} / month</p>
                        <p>{{ plan.description }}</p>
                        <input type="radio" name="selected_plan" value="{{ plan.id }}" onclick="setPlanId({{ plan.id }})"> Select {{ plan.name }}
                        <div class="associated-products" style="margin-left: 20px;"> <!-- Indent to the right -->
                            <h5>Products in {{ plan.name }}</h5>
                            <ul>
                                {% for product in plan.products %}
                                    <li>{{ product.name }} - ${{ product.price / 100 }}</li>
                                {% else %}
                                    <li>None</li>
                                {% endfor %}
                            </ul>
                        </div>
                        <div class="additional-products" style="margin-left: 20px;"> <!-- Indent to the right -->
                            <h5>Select Additional Products</h5>
                            <ul>
                                {% if additional_products %}
                                    {% for product in additional_products %}
                                        {% if product.id not in plan.product_ids %}
                                            <li style="margin-left: 20px;"> <!-- Indent product details -->
                                                <input type="checkbox" name="additional_products" value="{{ product.id }}">
                                                {{ product.name }} - ${{ product.price / 100 }}
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <li>None</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                    <hr>
                {% endfor %}
                <button type="submit" class="btn btn-success">Subscribe</button>
            </form>
        {% else %}
            <p>You already have an active subscription. Please unsubscribe first to choose a new plan.</p>
        {% endif %}
    </div>
</div>

<script>
    function setPlanId(planId) {
        console.log('Plan ID set to:', planId); // Debugging
        document.getElementById('plan_id').value = planId;
    }

    document.querySelectorAll('input[name="selected_plan"]').forEach(radio => {
        radio.addEventListener('change', function() {
            setPlanId(this.value);
        });
    });

    document.getElementById('subscriptionForm').addEventListener('submit', function() {
        const selectedPlan = document.querySelector('input[name="selected_plan"]:checked');
        if (selectedPlan) {
            setPlanId(selectedPlan.value);
        } else {
            alert('Please select a plan before submitting.');
            return false;
        }
    });
</script>
{% endblock %}
