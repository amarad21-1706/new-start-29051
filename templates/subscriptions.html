{% extends 'base.html' %}

{% block title %}
    Subscription Plans
{% endblock %}

{% block content %}
<div class="container">
    <h2>Choose Your Subscription Plan</h2>

    <hr>
    <div class="current-subscription">
        <h3>Current Subscription</h3>
        <p><strong>Plan:</strong> {{ subscription_info.plan }}</p>
        <p><strong>Status:</strong> {{ subscription_info.status }}</p>
        <p><strong>Start Date:</strong> {{ subscription_info.start_date }}</p>
        <p><strong>End Date:</strong> {{ subscription_info.end_date }}</p>
    </div>
    <hr>

    <div class="subscription-plans">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="alert-container">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        <hr>
        <form action="{{ url_for('subscribe') }}" method="POST" id="subscriptionForm">
            {{ form.hidden_tag() }}
            <input type="hidden" name="plan_id" id="plan_id">
            {% for plan in plans %}
                <div class="plan">
                    <h3>{{ plan.name }}</h3>
                    <p>${{ plan.price / 100 }} / month</p>
                    <p>{{ plan.description }}</p>
                    <input type="radio" name="selected_plan" value="{{ plan.id }}" onclick="setPlanId({{ plan.id }})"> Select {{ plan.name }}
                    <div class="associated-products">
                        <h4>Products in {{ plan.name }}</h4>
                        <ul>
                            {% for product in plan.products %}
                                <li>{{ product.name }} - ${{ product.price / 100 }}</li>
                            {% else %}
                                <li>None</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div class="additional-products">
                        <h4>Select Additional Products</h4>
                        <ul>
                            {% if additional_products %}
                                {% for product in additional_products %}
                                    {% if product.id not in plan.product_ids %}
                                        <li>
                                            <input type="checkbox" name="additional_products" value="{{ product.id }}">
                                            {{ product.name }} - ${{ product.price / 100 }}
                                        </li>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <li>None</li>
                            {% endif %}
                        </ul>
                    </div>
                </div>
                <hr>
            {% endfor %}
            <button type="submit" class="btn btn-success">Subscribe</button>
        </form>
    </div>
</div>

<script>

    function setPlanId(planId) {
        document.getElementById('plan_id').value = planId;
    }

    document.querySelectorAll('input[name="selected_plan"]').forEach(radio => {
        radio.addEventListener('change', function() {
            setPlanId(this.value);
        });
    });

    document.getElementById('subscriptionForm').addEventListener('submit', function() {
        const selectedPlan = document.querySelector('input[name="selected_plan"]:checked');
        if (selectedPlan) {
            setPlanId(selectedPlan.value);
        } else {
            alert('Please select a plan before submitting.');
            return false;
        }
    });

</script>
{% endblock %}
